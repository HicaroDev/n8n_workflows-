{"createdAt":"2025-04-28T22:50:30.529Z","updatedAt":"2025-04-28T22:54:36.000Z","id":"N6EYkUrwS0NIJEEU","name":"SextaFeira","active":false,"nodes":[{"parameters":{"url":"={{ $json.body.data.message.imageMessage.url }}","responseFormat":"file","options":{},"headerParametersUi":{"parameter":[{}]}},"id":"154df31a-8cd9-41c9-af55-f4b282d23353","name":"Download Imagem","type":"n8n-nodes-base.httpRequest","typeVersion":1,"position":[-100,20],"alwaysOutputData":true},{"parameters":{"resource":"chat","prompt":{"messages":[{"role":"system","content":"Você é um assistente financeiro especializado em extrair informações de imagens de comprovantes, notas fiscais e recibos. Extraia as seguintes informações: data, valor total, categoria (alimentação, transporte, moradia, etc.), descrição do item/serviço, e nome do fornecedor/estabelecimento. Retorne apenas um objeto JSON com os campos: data, valor, categoria, descricao, fornecedor."},{"content":"={{ \"Analise esta imagem de comprovante e extraia as informações financeiras.\" }}"}]},"options":{"maxTokens":1000,"temperature":0},"requestOptions":{}},"id":"fee5290d-77b1-4075-9e73-f825d4fa811d","name":"Analisar Imagem","type":"n8n-nodes-base.openAi","typeVersion":1,"position":[200,20],"credentials":{"openAiApi":{"id":"fUIOsGVnCLFrm3t8","name":"OpenAi 2"}}},{"parameters":{"assignments":{"assignments":[{"id":"072fccae-8d30-484d-a7e8-617df811f3e3","name":"Base64","value":"={{ $json.body.data.message.base64 }}","type":"string"},{"id":"d0a14d8b-cfb4-44fd-99c0-ba010e39f601","name":"remoteJid","value":"={{ $json.body.data.key.remoteJid }}","type":"string"},{"id":"0f54d482-2abc-4a08-9713-36cb6da06e5f","name":"Nome_usuario","value":"={{ $json.body.data.pushName }}","type":"string"},{"id":"5be72e05-65ee-4a46-8ffd-7c4c14645964","name":"Instancia","value":"","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-140,-360],"id":"f338bd79-96fa-44c4-9173-e15ac26b1dc2","name":"Tratando Audio","alwaysOutputData":true},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.body.data.messageType }}","rightValue":"audioMessage","operator":{"type":"string","operation":"equals"},"id":"63d687fe-0af1-429b-84c7-7ae73bf605e3"}],"combinator":"and"},"renameOutput":true,"outputKey":"AudioMessage"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"2c46acd9-f1b0-4275-9484-99c127e566f0","leftValue":"={{ $json.body.data.messageType }}","rightValue":"conversation","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Texto"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6b6a837a-6d2b-4421-a1c7-63ad94225965","leftValue":"={{ $json.body.data.messageType }}","rightValue":"imageMessage","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"renameOutput":true,"outputKey":"Imagem "}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-440,-480],"id":"9c9944d6-c058-4583-a286-b27f561e1760","name":"Switch"},{"parameters":{"operation":"toBinary","sourceProperty":"Base64","options":{"mimeType":"audio/mp3"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[40,-360],"id":"5802be08-59dc-40dd-8f6a-cfeaee75887c","name":"Convert to File"},{"parameters":{"resource":"audio","operation":"transcribe","options":{"language":"pt"}},"type":"@n8n/n8n-nodes-langchain.openAi","typeVersion":1.8,"position":[220,-360],"id":"a231e383-6995-4f66-b3ec-fadd27efa256","name":"OpenAI","alwaysOutputData":false,"executeOnce":false,"notesInFlow":false,"credentials":{"openAiApi":{"id":"fUIOsGVnCLFrm3t8","name":"OpenAi 2"}},"onError":"continueRegularOutput"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[380,-220],"id":"94d03f1b-f17c-443b-94bb-11c0e6da1557","name":"Merge","alwaysOutputData":false},{"parameters":{"operation":"getAll","tableId":"Entrada_dados","returnAll":true,"filters":{"conditions":[{"keyName":"remoteJid","condition":"eq","keyValue":"={{ $json.remoteJid }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[580,-220],"id":"eec158a2-6c9d-4de1-9be3-764a783f9fe8","name":"Supabase","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"b221yMmN6adp96Ic","name":"Supabase account"}}},{"parameters":{"tableId":"Entrada_dados","fieldsUi":{"fieldValues":[{"fieldId":"Nome","fieldValue":"={{ $('Webhook EvolutionAPI1').item.json.body.data.pushName }}"},{"fieldId":"remoteJid","fieldValue":"={{ $('Webhook EvolutionAPI1').item.json.body.data.key.remoteJid }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[980,-80],"id":"e886cab6-6d47-4e4e-a48c-193e64b6e8dd","name":"Supabase1","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"b221yMmN6adp96Ic","name":"Supabase account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ed52b4cd-a9fc-4073-881b-05cd4394cc2f","leftValue":"={{ $('Supabase').item.json.Liberado }}","rightValue":"","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[980,-260],"id":"a963b7d9-a8df-41ee-9120-00f663464d2e","name":"Liberação "},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"59e85a17-1e9e-4428-a6de-a367c427212a","leftValue":"={{ $item(\"0\").$node[\"Supabase\"].json }}","rightValue":"","operator":{"type":"object","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[760,-220],"id":"df3ad542-f956-43a3-9f53-204e4a2634b1","name":"Cadastro ","alwaysOutputData":false},{"parameters":{"model":{"__rl":true,"value":"gpt-3.5-turbo","mode":"list","cachedResultName":"gpt-3.5-turbo"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1220,-240],"id":"cbeb4999-b73f-4954-9637-3fd8e41b10a9","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"fUIOsGVnCLFrm3t8","name":"OpenAi 2"}}},{"parameters":{"assignments":{"assignments":[{"id":"072fccae-8d30-484d-a7e8-617df811f3e3","name":"Mensagem de Texto","value":"={{ $json.body.data.message.conversation }}","type":"string"},{"id":"456a96e1-0fc5-419d-84d0-a78c32d43582","name":"remoteJid","value":"={{ $json.body.data.key.remoteJid }}","type":"string"},{"id":"9beee9a5-59eb-4193-88c5-f6f0c17e125e","name":"Nome_do_Usuario","value":"={{ $json.body.data.pushName }}","type":"string"},{"id":"2fa1d135-74be-4e45-bf48-c72fc25f5d4a","name":"IdMessagem ","value":"={{ $json.body.data.key.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[40,-160],"id":"284efc22-e3f6-423b-8e2c-4c486e31f782","name":"Dados da Conversa","alwaysOutputData":false},{"parameters":{"promptType":"define","text":"={{ $item(\"0\").$node[\"Merge\"].json[\"Mensagem de Texto\"] }}","options":{"systemMessage":"retorne o nome do cliente "}},"type":"@n8n/n8n-nodes-langchain.agent","typeVersion":1.8,"position":[1360,-480],"id":"6750ffc4-82e9-4430-9cff-2a4c0b78c74f","name":"AI Agent","alwaysOutputData":false,"onError":"continueRegularOutput"},{"parameters":{"sessionIdType":"customKey","sessionKey":"={{ $('Liberação ').item.json.remoteJid }}"},"type":"@n8n/n8n-nodes-langchain.memoryRedisChat","typeVersion":1.5,"position":[1380,-200],"id":"8e6fd9f1-ab5d-4d88-8bd9-0bbb89b10f8f","name":"Redis Chat Memory","credentials":{"redis":{"id":"CMG5NzZphI7CpP2k","name":"Redis account"}}},{"parameters":{"resource":"chat-api","operation":"read-messages","instanceName":"={{ $('Webhook EvolutionAPI1').item.json.body.instance }}","remoteJid":"={{ $('Webhook EvolutionAPI1').item.json.body.data.pushName }}","messageId":"={{ $('Webhook EvolutionAPI1').item.json.body.data.key.id }}"},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2260,-520],"id":"587a5ec7-67c6-4a30-a040-06f43e93997f","name":"Evolution API","credentials":{"evolutionApi":{"id":"1eM2xZDmYfv6kfHj","name":"Evolution account"}}},{"parameters":{"resource":"messages-api","instanceName":"={{ $('Webhook EvolutionAPI1').item.json.body.instance }}","remoteJid":"={{ $('Webhook EvolutionAPI1').item.json.body.data.key.remoteJid }}","messageText":"={{ $item(\"0\").$node[\"AI Agent\"].json[\"output\"] }}","options_message":{"linkPreview":true}},"type":"n8n-nodes-evolution-api.evolutionApi","typeVersion":1,"position":[2220,-100],"id":"1c395c32-de1e-410d-bd6b-58f01b3ec4f2","name":"Responder","credentials":{"evolutionApi":{"id":"1eM2xZDmYfv6kfHj","name":"Evolution account"}}},{"parameters":{},"type":"@n8n/n8n-nodes-langchain.mcpClientTool","typeVersion":1,"position":[1420,-260],"id":"5697e3d9-3a13-4c09-9683-85c6599680ef","name":"MCP Client"},{"parameters":{"options":{}},"type":"@n8n/n8n-nodes-langchain.chatTrigger","typeVersion":1.1,"position":[-680,-340],"id":"4e39783d-b5ae-4e97-bb9c-5f014288e655","name":"When chat message received","webhookId":"5c166fb5-e6d3-4fb8-8ae2-82ff29b744b3"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.chatInput }}","rightValue":"","operator":{"type":"string","operation":"exists","singleValue":true},"id":"3fd07a0f-be19-478a-bf50-97d5ee3b3897"}],"combinator":"and"},"renameOutput":true,"outputKey":"Mensagem"},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"db3c9b59-7238-4684-b26e-e2d25b2f0009","leftValue":"","rightValue":"","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"}}]},"options":{}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-480,-300],"id":"e0b9c1b5-fe49-48c2-92ee-6777ea73ee04","name":"Switch1"}],"connections":{"Download Imagem":{"main":[[]]},"Analisar Imagem":{"main":[[]]},"Switch":{"main":[[],[],[]]},"Tratando Audio":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"OpenAI","type":"main","index":0}]]},"OpenAI":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Supabase","type":"main","index":0}]]},"Supabase":{"main":[[{"node":"Cadastro ","type":"main","index":0}]]},"Cadastro ":{"main":[[{"node":"Liberação ","type":"main","index":0}],[{"node":"Supabase1","type":"main","index":0}]]},"Liberação ":{"main":[[{"node":"AI Agent","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"AI Agent","type":"ai_languageModel","index":0}]]},"Dados da Conversa":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Redis Chat Memory":{"ai_memory":[[{"node":"AI Agent","type":"ai_memory","index":0}]]},"AI Agent":{"main":[[{"node":"Evolution API","type":"main","index":0}]]},"Evolution API":{"main":[[{"node":"Responder","type":"main","index":0}]]},"MCP Client":{"ai_tool":[[{"node":"AI Agent","type":"ai_tool","index":0}]]},"When chat message received":{"main":[[{"node":"Switch1","type":"main","index":0}]]},"Switch1":{"main":[[{"node":"Dados da Conversa","type":"main","index":0}]]}},"settings":{"executionOrder":"v1"},"staticData":null,"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"d355bb73-98fe-47b3-b8cc-17a0bc071d58","triggerCount":1,"tags":[]}